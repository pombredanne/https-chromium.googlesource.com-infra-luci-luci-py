{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "d7bdcdf2_03219c0c",
        "filename": "appengine/swarming/api_common.py",
        "patchSetId": 5
      },
      "lineNbr": 341,
      "author": {
        "id": 1547372
      },
      "writtenOn": "2023-02-24T17:21:47Z",
      "side": 1,
      "message": "I\u0027m guessing the mistake was using the `BlobProperty` type to store the task output rather than a `utf-8` encoded string ?",
      "range": {
        "startLine": 341,
        "startChar": 4,
        "endLine": 341,
        "endChar": 47
      },
      "revId": "0964a6a1218d52dd9109c8e5ea14ff862e99bd6d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "46d5e5a5_829bbcfe",
        "filename": "appengine/swarming/api_common.py",
        "patchSetId": 5
      },
      "lineNbr": 341,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-02-24T22:47:11Z",
      "side": 1,
      "message": "This is a complicated question, I don\u0027t know the answer. It depends on how Swarming bot collects output from the task process (it can open the stdout pipe in text mode or in binary mode). If it collects outputs as binary, then it should be propagated through all guts as bytes, and show up in pRPC output as `bytes` protobuf field as well, not `string`.\n\nIf it collects it as text, it should guarantee it is valid utf-8. Trying to store arbitrary bytes in string-valued fields will result in lots of pain.\n\nThis requires more digging into what outputs are stored now and how. I\u0027m not 100% convinced using `string` protobuf field is correct.",
      "parentUuid": "d7bdcdf2_03219c0c",
      "range": {
        "startLine": 341,
        "startChar": 4,
        "endLine": 341,
        "endChar": 47
      },
      "revId": "0964a6a1218d52dd9109c8e5ea14ff862e99bd6d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c897f470_645e96bb",
        "filename": "appengine/swarming/api_common.py",
        "patchSetId": 5
      },
      "lineNbr": 341,
      "author": {
        "id": 1547372
      },
      "writtenOn": "2023-02-27T17:57:07Z",
      "side": 1,
      "message": "Took a more detailed looked based on `task_runner.py` - it seems like whatever bytes come from stderr and stdout are encoded to b64 then transmitted. \n\nAgree about use of `StringField` being the issue. `ByteField` is possible field definition in both `protorpc` and `protobuf`. See http://screen/7BvmaDrAGopoiuV \n\nIn principle the client should decide whether or not to decode `utf-8` - they should receive b64 encoded bytes which they then decide how to handle. However we will be introducing an incompatibility between the `pRPC` api and `protorpc` if we use a `bytes` field. \n\nI\u0027m not aware of significant complaints about output being forced into `utf-8`. It\u0027s likely only used for logging and is therefore mostly text, so to me the tradeoff leans towards leaving it be but having the correct behaviour if a totally new swarming `api` is created. WDYT?",
      "parentUuid": "46d5e5a5_829bbcfe",
      "range": {
        "startLine": 341,
        "startChar": 4,
        "endLine": 341,
        "endChar": 47
      },
      "revId": "0964a6a1218d52dd9109c8e5ea14ff862e99bd6d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}