{
  "comments": [
    {
      "key": {
        "uuid": "ec7edf15_a501a00a",
        "filename": "appengine/swarming/server/bot_management.py",
        "patchSetId": 10
      },
      "lineNbr": 589,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2020-02-27T01:47:47Z",
      "side": 1,
      "message": "IMHO, the simpler is still better to not store BotInfo in bot_connected. I don\u0027t think this solve the problem, in fact it makes it worse, because then all task queues may get stripped.\nYes first_seen will be a bit delayed, but it\u0027s fine IMO.",
      "revId": "cbfd214506b924606f981dfa35a320a57a8b9c0d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dad8e802_dd34b966",
        "filename": "appengine/swarming/server/bot_management.py",
        "patchSetId": 10
      },
      "lineNbr": 589,
      "author": {
        "id": 1366072
      },
      "writtenOn": "2020-02-27T02:05:15Z",
      "side": 1,
      "message": "I can accept the first_seen delay since I confirmed that it looks like only for display purpose. But the issue I faced with was that there are /event API calls between handshake and first poll. And the event API need to update BotInfo.\n\nI probably could skip updating BotInfo at event API until it\u0027s created at first poll.\nBut I thought it\u0027s also not good.\n\n\u003e it makes it worse, because then all task queues may get stripped.\n\nI don\u0027t understand this. This should be better since the dimensions are kept if they are the same with the stored one, otherwise the same with before.\nBut this solution didn\u0027t work for crbug.com/1054154, since the bot had a custom dimension.\n\nI\u0027m considering to keep dimensions if they are a subset of the stored dimensions, which should cover many cases (I\u0027m not sure)",
      "parentUuid": "ec7edf15_a501a00a",
      "revId": "cbfd214506b924606f981dfa35a320a57a8b9c0d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4e0774e9_a48af499",
        "filename": "appengine/swarming/server/bot_management.py",
        "patchSetId": 10
      },
      "lineNbr": 589,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2020-02-27T02:18:46Z",
      "side": 1,
      "message": "That\u0027s too bad about event. You are right, I hadn\u0027t had thought about that.\n\nI guess the right long term fix are https://crbug.com/786735 and https://crbug.com/786734.",
      "parentUuid": "dad8e802_dd34b966",
      "revId": "cbfd214506b924606f981dfa35a320a57a8b9c0d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ae4e6401_9e429180",
        "filename": "appengine/swarming/server/bot_management.py",
        "patchSetId": 10
      },
      "lineNbr": 589,
      "author": {
        "id": 1366072
      },
      "writtenOn": "2020-02-28T04:29:50Z",
      "side": 1,
      "message": "\u003e I guess the right long term fix are https://crbug.com/786735 and https://crbug.com/786734.\n\nAssuming that restart creates a new session, the session won\u0027t fix the windows perf builder.\nIIUC,they expect the dimensions to be kept even during restart for perf_device_trigger.py to be able to find eligible bots.\n\nMaybe, It\u0027s an opposite request...   \n\nWill look closely look at their script and consider a workaround.",
      "parentUuid": "4e0774e9_a48af499",
      "revId": "cbfd214506b924606f981dfa35a320a57a8b9c0d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c7757b25_8b5cbecc",
        "filename": "appengine/swarming/server/bot_management.py",
        "patchSetId": 10
      },
      "lineNbr": 589,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2020-02-28T16:50:35Z",
      "side": 1,
      "message": "The session would fix it from the same perspective where there must be a protocol to negotiate the dimensions:\n\n1) Bot present itself with an id, a few other dimensions from stock bot_config.py and a mean to authenticate. It requests a session.\n2) Server replies with an injected bot_config.py.\n3) Bot runs it, augments its dimensions, present this to the server.\n4) Server acknowledge the final dimensions, starts the bot session, registers the dimensions.\n\nThe challenge is when there\u0027s an /event RPC in-between, but still the important point is to BotInfo.dimensions to not be updated to not affect either task_queues.rebuild_task_cache_async() and task_queues.assert_bot_async(). Right now assert_bot_async() is not called in the /handshake RPC so that\u0027s cool, but rebuild_task_cache_async() can still run in-between and get the incorrect BotInfo. That\u0027s what happens with perf folks.\n\nhttps://source.chromium.org/chromium/infra/infra/+/master:luci/appengine/swarming/server/task_queues.py",
      "parentUuid": "ae4e6401_9e429180",
      "revId": "cbfd214506b924606f981dfa35a320a57a8b9c0d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "03a8bcba_97529e2c",
        "filename": "appengine/swarming/server/bot_management.py",
        "patchSetId": 10
      },
      "lineNbr": 589,
      "author": {
        "id": 1366072
      },
      "writtenOn": "2020-03-02T04:37:08Z",
      "side": 1,
      "message": "\u003e Right now assert_bot_async() is not called in the /handshake RPC so that\u0027s cool, but rebuild_task_cache_async() can still run in-between and get the incorrect BotInfo.\n\nNote that I moved assert_bot_async to run it only in the /poll path.\nhttps://source.chromium.org/chromium/_/chromium/infra/luci/luci-py/+/6305a694ed3293efe6f87960d7e1918b799ac21e:appengine/swarming/handlers_bot.py;l\u003d594;drc\u003dcbfd214506b924606f981dfa35a320a57a8b9c0d?originalUrl\u003dhttps:%2F%2Fcs.chromium.org%2F\n\nSo I don\u0027t think the event API updates something related dimension caches.\n\n\u003e rebuild_task_cache_async() can still run in-between and get the incorrect BotInfo\n\nPlease correct me if I\u0027m wrong. I thought task_queues.py doesn\u0027t update BotInfo.\n\nI think the perf folk\u0027s issue is...\n1) A Bot finishes a task (and restarts for some reason).\n2) The Bot does handshake with dimensions id and pool. \n(BotInfo.dimensions_flat has only id and pool during this period.)\n3) The bot does poll with proper dimensions.\n(BotInfo.dimensions_flat now has all dimensions.)\n\nThe script can\u0027t find eligible bots between 2) and 3).",
      "parentUuid": "c7757b25_8b5cbecc",
      "revId": "cbfd214506b924606f981dfa35a320a57a8b9c0d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c0eeced4_7584cd94",
        "filename": "appengine/swarming/server/bot_management.py",
        "patchSetId": 10
      },
      "lineNbr": 589,
      "author": {
        "id": 1366072
      },
      "writtenOn": "2020-03-05T01:24:35Z",
      "side": 1,
      "message": "Made another CL crrev.com/c/2084320",
      "parentUuid": "03a8bcba_97529e2c",
      "revId": "cbfd214506b924606f981dfa35a320a57a8b9c0d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "475077a8_d599cf8e",
        "filename": "appengine/swarming/server/bot_management.py",
        "patchSetId": 10
      },
      "lineNbr": 589,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2020-03-08T17:36:12Z",
      "side": 1,
      "message": "See:\nhttps://source.chromium.org/chromium/infra/infra/+/master:luci/appengine/swarming/server/bot_management.py;l\u003d689\nthen\nhttps://source.chromium.org/chromium/infra/infra/+/master:luci/appengine/swarming/server/bot_management.py;l\u003d703?q\u003dset_has_capacity\n\nThis is run as part of the task request flow (tasks/new and fallbacks), not as part of the bot events flow (/poll).\n\nIf BotInfo is stored with incomplete dimensions and tasks come in at the same time, there can be a race condition.",
      "parentUuid": "c0eeced4_7584cd94",
      "revId": "cbfd214506b924606f981dfa35a320a57a8b9c0d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}