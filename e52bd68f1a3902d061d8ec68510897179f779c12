{
  "comments": [
    {
      "key": {
        "uuid": "d59166c8_e2ce5825",
        "filename": "appengine/swarming/cron.yaml",
        "patchSetId": 13
      },
      "lineNbr": 93,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "Warning: because of the way AppEngine works, when we upload a new version of the code, cron.yaml takes effect immediately but the code run is still the old code until the version is switched.\n\nSo often to make the release smoother we add the handlers, and push that, and only then we update cron.yaml. But it\u0027s not necessarily a big deal.",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d6e73d34_e2a98489",
        "filename": "appengine/swarming/cron.yaml",
        "patchSetId": 13
      },
      "lineNbr": 93,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Thanks for pointing that. I should move this change to next CL and submit it after the worker has deployed.",
      "parentUuid": "d59166c8_e2ce5825",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "105d636b_1b243025",
        "filename": "appengine/swarming/queue.yaml",
        "patchSetId": 13
      },
      "lineNbr": 63,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "Similarly, this will take effect as soon as it is uploaded, but this is fine, since this is what we want for queues (unlike cron).",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fbc97c6c_6ffc8018",
        "filename": "appengine/swarming/queue.yaml",
        "patchSetId": 13
      },
      "lineNbr": 63,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Yes, I think this is safe, since we just add a pull queue for scheduler. Unless we flip the flag(batch_mode) to True, no task will be added here.",
      "parentUuid": "105d636b_1b243025",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0aed7227_782efeba",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 17,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "Keep sorted, in this case api is before ext.",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "778e8574_52b62184",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 17,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "0aed7227_782efeba",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6929dae5_c54a9a7d",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 225,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "This fits 80 cols, put all on one line.",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d377dd2a_8d4e79be",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 225,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6929dae5_c54a9a7d",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "eeba5cda_785e4757",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 229,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "if not req.add(queue_name\u003d\u0027es-notify-tasks-batch\u0027):",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "727a670c_2e4227bb",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 229,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "eeba5cda_785e4757",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0ac218aa_6fa9735c",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 253,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "I\u0027m not a fan of the function name but I don\u0027t have a better idea.",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2b6058d0_5c0b33c3",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 253,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Agree with you. I changed it to \"gen_batch_requests\". \nSounds better?",
      "parentUuid": "0ac218aa_6fa9735c",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "845990ad_b3cd85f1",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 260,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "I\u0027d recommend 55, since the actual work takes time.\n\nAlso, I recommend using:\n\n  end_time \u003d utils.utcnow() + datetime.timedelta(seconds\u003d55)\n  while utils.utcnow() \u003c end_time:\n\n\nso then you can use mock_now() in the tests.",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ab68ae95_218fcc22",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 260,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Not 100% sure, but I think mock_now() could not help here. If we don\u0027t mock anything, the unit test may still complete in one minute. To accelerate it, I mocked the time() method. Every time when it is called, I return now + 30 sec, so that it just loops twice at most in the unit test. \nPer my understanding, if I called \"external_scheduler.gen_batch_requests()\", I could not change mock_now() during it is running, correct?\n\n+1 on 55 seconds. Also named those constants, I think high possibility we may need to tune them in the future.",
      "parentUuid": "845990ad_b3cd85f1",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a6f025a5_e2fc7700",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 272,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "You never do anything with it.",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "495443e4_18f634a0",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 272,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "My bad. We definitely should remove the tasks already processed.",
      "parentUuid": "a6f025a5_e2fc7700",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bffc862a_bdef8d28",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 277,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "+4",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a578ce26_5a9ae0f7",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 277,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "bffc862a_bdef8d28",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fe0a9582_fc3c14ad",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 287,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "The problem here is that the items are lost.",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8b53d6c9_2cee1827",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 287,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "If an error raised, we do not delete those tasks. Thus, after the lease expire, next worker will try to process them again.",
      "parentUuid": "fe0a9582_fc3c14ad",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "940db456_58c395a8",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 289,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "Unnecessary?",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f9bed39c_7280a640",
        "filename": "appengine/swarming/server/external_scheduler.py",
        "patchSetId": 13
      },
      "lineNbr": 289,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Done.",
      "parentUuid": "940db456_58c395a8",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "77899406_49e9d48a",
        "filename": "appengine/swarming/server/external_scheduler_test.py",
        "patchSetId": 13
      },
      "lineNbr": 231,
      "author": {
        "id": 1000487
      },
      "writtenOn": "2019-07-02T04:20:50Z",
      "side": 1,
      "message": "I recommend more extensive testing, since when this breaks, this has catastrophic outcome when pushed to prod.",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0580b4a5_2da4653f",
        "filename": "appengine/swarming/server/external_scheduler_test.py",
        "patchSetId": 13
      },
      "lineNbr": 231,
      "author": {
        "id": 1336288
      },
      "writtenOn": "2019-07-03T06:14:00Z",
      "side": 1,
      "message": "Added new test here to verify the requests were combined as expected. Also check if they were removed ultimately.",
      "parentUuid": "77899406_49e9d48a",
      "revId": "e52bd68f1a3902d061d8ec68510897179f779c12",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}