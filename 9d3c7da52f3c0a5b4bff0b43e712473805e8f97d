{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "d09e3ab4_e071a882",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 4
      },
      "lineNbr": 1307,
      "author": {
        "id": 1366072
      },
      "writtenOn": "2021-06-08T08:26:53Z",
      "side": 1,
      "message": "I think task slice expiration can be delayed due to Datastore or some other reasons.\n\nSo this max_lifetime_secs calculation isn\u0027t reliable?",
      "range": {
        "startLine": 1307,
        "startChar": 18,
        "endLine": 1307,
        "endChar": 33
      },
      "revId": "9d3c7da52f3c0a5b4bff0b43e712473805e8f97d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "944ade32_265fe2b6",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 4
      },
      "lineNbr": 1307,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2021-06-08T09:10:28Z",
      "side": 1,
      "message": "I\u0027d like to ignore such unexpected delay here as how much delay we\u0027ll see is also unexpected.\nEven if that happens, I\u0027d like to use calculated deadline until when that become problematic.\n\nAnd I think it is fine not to guarantee about what happens if tasks exceeded specified deadline.",
      "parentUuid": "d09e3ab4_e071a882",
      "range": {
        "startLine": 1307,
        "startChar": 18,
        "endLine": 1307,
        "endChar": 33
      },
      "revId": "9d3c7da52f3c0a5b4bff0b43e712473805e8f97d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2c30452a_b68f157b",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 4
      },
      "lineNbr": 1307,
      "author": {
        "id": 1157909
      },
      "writtenOn": "2021-06-08T18:32:39Z",
      "side": 1,
      "message": "\u003e And I think it is fine not to guarantee about what happens if tasks exceeded specified deadline.\n\nFWIW, in ResultDB an invocation will be forcefully finalized if it exceeds the specified deadline. But if a task is predicted to exceed its deadline, swarming can choose to update it invocation (before deadline, while it\u0027s still active) to extend its deadline though.",
      "parentUuid": "944ade32_265fe2b6",
      "range": {
        "startLine": 1307,
        "startChar": 18,
        "endLine": 1307,
        "endChar": 33
      },
      "revId": "9d3c7da52f3c0a5b4bff0b43e712473805e8f97d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "146e8221_f5a485ab",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 4
      },
      "lineNbr": 1307,
      "author": {
        "id": 1366072
      },
      "writtenOn": "2021-06-09T02:41:43Z",
      "side": 1,
      "message": "\u003e ignore such unexpected delay\n\nEven in a regular situation, there is some latency for task slice switch.\nIt\u0027s usually a few minutes.\n\nSo a task can keep running after the deadline.\nIt\u0027s an edge case, but possible.\n\nWhy does the deadline of invocation need to be so strict?\n\nI noticed that service_account_token also has this issue. But the rational may be different since it grants permissions.\nhttps://source.chromium.org/chromium/infra/infra/+/main:luci/appengine/swarming/handlers_endpoints.py;l\u003d606-609;drc\u003dbf1867e975fdefe7ac3f2908782c73dac4e3d1fa",
      "parentUuid": "2c30452a_b68f157b",
      "range": {
        "startLine": 1307,
        "startChar": 18,
        "endLine": 1307,
        "endChar": 33
      },
      "revId": "9d3c7da52f3c0a5b4bff0b43e712473805e8f97d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "be94a3ec_d6b6c674",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 4
      },
      "lineNbr": 1307,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2021-06-09T08:26:24Z",
      "side": 1,
      "message": "\u003e \u003e ignore such unexpected delay\n\u003e \n\u003e Even in a regular situation, there is some latency for task slice switch.\n\u003e It\u0027s usually a few minutes.\n\u003e \n\u003e So a task can keep running after the deadline.\n\u003e It\u0027s an edge case, but possible.\n\u003e \n\u003e Why does the deadline of invocation need to be so strict?\n\u003e \n\nI think it is better to use 0 as buffer for now because I don\u0027t know what is appropriate value if 0 is not appropriate.\nAnd if there are failed tasks due to such deadline, it is better to increase timeout for such tasks. Or at least I prefer to defer non zero buffer time until we see such tasks to know appropriate buffer.",
      "parentUuid": "146e8221_f5a485ab",
      "range": {
        "startLine": 1307,
        "startChar": 18,
        "endLine": 1307,
        "endChar": 33
      },
      "revId": "9d3c7da52f3c0a5b4bff0b43e712473805e8f97d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "86e0e03e_fd36a6e5",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 4
      },
      "lineNbr": 1307,
      "author": {
        "id": 1366072
      },
      "writtenOn": "2021-06-09T08:44:46Z",
      "side": 1,
      "message": "\u003e I think it is better to use 0 as buffer for now because I don\u0027t know what is appropriate value if 0 is not appropriate.\n\nAn appropriate buffer depends on the reason why we want to set deadline.\n(It can be 10min, 1hour etc)\n\nAs Chan suggested, we could update the deadline at task slice. It requires yet another RPC call, though.",
      "parentUuid": "be94a3ec_d6b6c674",
      "range": {
        "startLine": 1307,
        "startChar": 18,
        "endLine": 1307,
        "endChar": 33
      },
      "revId": "9d3c7da52f3c0a5b4bff0b43e712473805e8f97d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6625b1ac_1263f31e",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 4
      },
      "lineNbr": 1315,
      "author": {
        "id": 1366072
      },
      "writtenOn": "2021-06-08T08:31:16Z",
      "side": 1,
      "message": "There are different deadlines.\n- schedule deadline\n- task execution deadline\n\nSo it should be more explicit.\nIn this case, `execution_deadline` would be appropriate.\nBut I concern the accuracy of the calculation for the reason I commented.\n\nAnd, we don\u0027t want to depend on this deadline (maybe?).\nSo instead of making this property method, I would move this calculation (+ some buffer) right before resultdb.create_invocation_async() for now.",
      "range": {
        "startLine": 1315,
        "startChar": 6,
        "endLine": 1315,
        "endChar": 14
      },
      "revId": "9d3c7da52f3c0a5b4bff0b43e712473805e8f97d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "17c586ff_b2192f8d",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 4
      },
      "lineNbr": 1315,
      "author": {
        "id": 1161379
      },
      "writtenOn": "2021-06-08T09:10:28Z",
      "side": 1,
      "message": "renamed to execution_deadline.\n\nI prefer to keep this for narrow scoped unit test.",
      "parentUuid": "6625b1ac_1263f31e",
      "range": {
        "startLine": 1315,
        "startChar": 6,
        "endLine": 1315,
        "endChar": 14
      },
      "revId": "9d3c7da52f3c0a5b4bff0b43e712473805e8f97d",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}