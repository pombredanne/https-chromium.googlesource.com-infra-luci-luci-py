{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "0cdfad45_c50fd99b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 31
      },
      "lineNbr": 0,
      "author": {
        "id": 1551397
      },
      "writtenOn": "2023-07-28T19:03:57Z",
      "side": 1,
      "message": "This CL has been now updated to reflect the changed from https://crrev.com/c/4726326 and https://crrev.com/c/4715699",
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ccf723e3_eac43cc8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 31
      },
      "lineNbr": 0,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-07-28T20:34:47Z",
      "side": 1,
      "message": "How solid does this notification need to be?\n\nBecause Swarming task can change state in a bunch of other ways (when it expires, when the bot that executes it dies, when the task fails with an internal error). See calls to _maybe_taskupdate_notify_via_tq.",
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4be805fa_819bfd99",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 31
      },
      "lineNbr": 0,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-08-03T17:35:27Z",
      "side": 1,
      "message": "Ping ^^^",
      "parentUuid": "ccf723e3_eac43cc8",
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8034efde_aa83961f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 31
      },
      "lineNbr": 0,
      "author": {
        "id": 1551397
      },
      "writtenOn": "2023-08-03T18:04:09Z",
      "side": 1,
      "message": "Sorry I missed this comment! So the UpdateBuildTask notification really should only happen on task state change and that is decided here https://source.chromium.org/chromium/infra/infra/+/main:luci/appengine/swarming/backend_conversions.py;l\u003d237. This was code that was written some time ago (refactored recently by me), but looks right to me.\n\nI think this is solid enough for UpdateBuildTask since Task.status_details is being set. \n\nActually now that I write this I realize we might need to send updates if status_details is changed... I think the conditional \"do we send update\" should be then decided on a change in swarming\u0027s task state and not the BB task status. That way we can update Task.status_details.\n\nThoughts?",
      "parentUuid": "4be805fa_819bfd99",
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "627d1c7c_cab9d743",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 31
      },
      "lineNbr": 0,
      "author": {
        "id": 1551397
      },
      "writtenOn": "2023-08-04T17:37:39Z",
      "side": 1,
      "message": "Code has been updated to only send bb updates on swarming task state changes, and BuildTask now stores previous updated swarming task state instead of a bb status.",
      "parentUuid": "8034efde_aa83961f",
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3b962846_8319222c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 31
      },
      "lineNbr": 0,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-08-04T18:02:22Z",
      "side": 1,
      "message": "This code will miss task states such as CLIENT_ERROR, BOT_DIED, some of CANCELED, NO_RESOURCE, EXPIRED.\n\nIt handles only the happy path of bot calling /bot/task_update. But if the bot dies, or the task never reaches the bot, or the bot can\u0027t start it, no notifications to BB will be sent.",
      "parentUuid": "627d1c7c_cab9d743",
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4beebea3_bf0d7b1f",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 31
      },
      "lineNbr": 619,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-07-28T20:34:47Z",
      "side": 1,
      "message": "topic",
      "range": {
        "startLine": 619,
        "startChar": 15,
        "endLine": 619,
        "endChar": 27
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "24dbefbe_7c506190",
        "filename": "appengine/swarming/server/task_request.py",
        "patchSetId": 31
      },
      "lineNbr": 619,
      "author": {
        "id": 1551397
      },
      "writtenOn": "2023-07-28T21:32:37Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4beebea3_bf0d7b1f",
      "range": {
        "startLine": 619,
        "startChar": 15,
        "endLine": 619,
        "endChar": 27
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f219726f_e660afc7",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 553,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-07-28T20:34:47Z",
      "side": 1,
      "message": "buildbucket",
      "range": {
        "startLine": 553,
        "startChar": 32,
        "endLine": 553,
        "endChar": 43
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d91e0a94_127b01aa",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 553,
      "author": {
        "id": 1551397
      },
      "writtenOn": "2023-07-28T21:32:37Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f219726f_e660afc7",
      "range": {
        "startLine": 553,
        "startChar": 32,
        "endLine": 553,
        "endChar": 43
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ad6c62cb_578fae70",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 1800,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-07-28T20:34:47Z",
      "side": 1,
      "message": "task cancelation should probably propagate to BB as well?\n\nHow about:\n\n```\nrun_result_state \u003d run_result.state\nif run_result.killing:\n  run_result_state \u003d task_result.State.KILLED\n\nif request.has_build_task:\n  ...\n\nreturn run_result_state\n```",
      "range": {
        "startLine": 1799,
        "startChar": 0,
        "endLine": 1800,
        "endChar": 35
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3a61512e_774ae347",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 1800,
      "author": {
        "id": 1551397
      },
      "writtenOn": "2023-07-28T21:32:37Z",
      "side": 1,
      "message": "SGTM. Changed!",
      "parentUuid": "ad6c62cb_578fae70",
      "range": {
        "startLine": 1799,
        "startChar": 0,
        "endLine": 1800,
        "endChar": 35
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1b55bf4c_a5af3331",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 1817,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-07-28T20:34:47Z",
      "side": 1,
      "message": "why is it Struct instead of something with a realm schema? What will be interpreting it?",
      "range": {
        "startLine": 1817,
        "startChar": 26,
        "endLine": 1817,
        "endChar": 45
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2d10dd30_e2b3c0de",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 1817,
      "author": {
        "id": 1551397
      },
      "writtenOn": "2023-07-28T21:32:37Z",
      "side": 1,
      "message": "This struct is \"generic\" for backend owners to interpret downstream. BB does nothing with this info other than store it in the Task proto and export that to BQ. So far the first usecase of the Task.Details will be for recipes that lookup hardcoded bot info (in Build.Infra.Swarming.BotDimensions). They will now need to pull bot info from Build.Infra.Backend.Task.Details.\n\nIt is intentionally not a specific schema and a struct so we don\u0027t silo backend owners.",
      "parentUuid": "1b55bf4c_a5af3331",
      "range": {
        "startLine": 1817,
        "startChar": 26,
        "endLine": 1817,
        "endChar": 45
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f63130db_b4f6f870",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 1822,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-07-28T20:34:47Z",
      "side": 1,
      "message": "This will be 1s granularity, i.e. if updates happen within the same second they\u0027ll have the same ID. This not good. Better to increase the precision or use something else instead (e.g. a counter stored in build_task).",
      "range": {
        "startLine": 1822,
        "startChar": 28,
        "endLine": 1822,
        "endChar": 60
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "570f1d5a_0e0849b3",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 1822,
      "author": {
        "id": 1551397
      },
      "writtenOn": "2023-07-28T21:32:37Z",
      "side": 1,
      "message": "I decided to make a time_time_ns util instead, that way we can use nanoseconds for update_id. it would be easier to use a counter stored in build_task, but I worry that it could lead to race-y things, and only BB needs to worry about update_id, so I think using ns is ok here.",
      "parentUuid": "f63130db_b4f6f870",
      "range": {
        "startLine": 1822,
        "startChar": 28,
        "endLine": 1822,
        "endChar": 60
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ba00fc5b_41ba5db0",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 1836,
      "author": {
        "id": 1002539
      },
      "writtenOn": "2023-07-28T20:34:47Z",
      "side": 1,
      "message": "Should this be inside `if build_task.published_task_status !\u003d bb_task.status:` condition? Why do we store build_task all the time, even if nothing has changed?",
      "range": {
        "startLine": 1832,
        "startChar": 0,
        "endLine": 1836,
        "endChar": 20
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "460979f1_b5f6caeb",
        "filename": "appengine/swarming/server/task_scheduler.py",
        "patchSetId": 31
      },
      "lineNbr": 1836,
      "author": {
        "id": 1551397
      },
      "writtenOn": "2023-07-28T21:32:37Z",
      "side": 1,
      "message": "good call out. shifted all this code over to be in that conditional block.",
      "parentUuid": "ba00fc5b_41ba5db0",
      "range": {
        "startLine": 1832,
        "startChar": 0,
        "endLine": 1836,
        "endChar": 20
      },
      "revId": "5b68e184715c14a05e824226129408ba70732b05",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}